# -*- coding: utf-8 -*-
"""ML_Project.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tOY9UYC6dXvd0b339bRRi--fZBMmo-yl

# Project
"""

import pandas as pd

# from google.colab import files
# uploaded = files.upload()

df = pd.read_csv('auto24_cars_raw.csv')

print(f"Dataset has {df.shape[0]} rows and {df.shape[1]} columns")
print(f"\nColumn names:\n{df.columns.tolist()}")
print(f"\nFirst 5 rows:")
print(df.head())

# Before removing duplicates
print(f"Original rows: {len(df)}")

# Remove duplicates
df = df.drop_duplicates(subset=['url'])

# After removing duplicates
print(f"Rows after removing duplicates: {len(df)}")

# Before removing
print(f"Original rows: {len(df)}")

# Remove rows with any missing values
df = df.dropna()

# After removing
print(f"Rows after removing missing values: {len(df)}")

#Translate
df['type'] = df['type'].replace('maastur', 'suv')
df['type'] = df['type'].replace('sÃµiduauto', 'passenger')

# Split by whitespace and take the first word
df['body_type'] = df['body_type'].str.split().str[0]

df['body_type'] = df['body_type'].replace('sedaan', 'sedan')
df['body_type'] = df['body_type'].replace('universaal', 'touring')
df['body_type'] = df['body_type'].replace('luukpÃ¤ra', 'hatchback')
df['body_type'] = df['body_type'].replace('mahtuniversaal', 'minivan')
df['body_type'] = df['body_type'].replace('kabriolett', 'cabriolet')
df['body_type'] = df['body_type'].replace('pikap', 'pickup')
df['body_type'] = df['body_type'].replace('kupee', 'coupe')
df['body_type'] = df['body_type'].replace('lahtine', 'open')
df['body_type'] = df['body_type'].replace('limusiin', 'limousine')

df['fuel'] = df['fuel'].replace('bensiin + gaas (LPG/vedelgaas)', 'bensiin + gaas')
df['fuel'] = df['fuel'].replace('bensiin + gaas (CNG/surugaas)', 'bensiin + gaas')
df['fuel'] = df['fuel'].replace('hÃ¼briid (bensiin / elekter)', 'hÃ¼briid')
df['fuel'] = df['fuel'].replace('hÃ¼briid (diisel / elekter)', 'hÃ¼briid')
df['fuel'] = df['fuel'].replace('gaas (CNG/surugaas)', 'gaas')
df['fuel'] = df['fuel'].replace('gaas (LPG/vedelgaas)', 'gaas')
df['fuel'] = df['fuel'].replace('pistikhÃ¼briid (diisel / elekter)', 'pistikhÃ¼briid')
df['fuel'] = df['fuel'].replace('pistikhÃ¼briid (bensiin / elekter)', 'pistikhÃ¼briid')

df['fuel'] = df['fuel'].replace('diisel', 'diesel')
df['fuel'] = df['fuel'].replace('bensiin', 'petrol')
df['fuel'] = df['fuel'].replace('bensiin + gaas', 'petrol + gas')
df['fuel'] = df['fuel'].replace('hÃ¼briid', 'hybrid')
df['fuel'] = df['fuel'].replace('elekter', 'electric')
df['fuel'] = df['fuel'].replace('gaas', 'gas')
df['fuel'] = df['fuel'].replace('pistikhÃ¼briid', 'plug-in hybrid')
df['fuel'] = df['fuel'].replace('vesinik', 'hydrogen')
df['fuel'] = df['fuel'].replace('etanool', 'ethanol')

df['drive_type'] = df['drive_type'].replace('nelikvedu', 'four-wheel drive')
df['drive_type'] = df['drive_type'].replace('esivedu', 'front-wheel drive')
df['drive_type'] = df['drive_type'].replace('tagavedu', 'rear-wheel drive')

df['gearbox'] = df['gearbox'].str.split().str[0]

# Remove rows where gearbox equals '(Konstantne'
df = df[df['gearbox'] != '(konstantne']
df = df[df['gearbox'] != '(Konstantne']

df['color'] = df['color'].str.split().str[0]

# Create translation dictionary
color_translation = {
    'punane': 'red',
    'must': 'black',
    'valge': 'white',
    'helesinine': 'light blue',
    'hÃµbedane': 'silver',
    'roheline': 'green',
    'heleroheline': 'light green',
    'hall': 'gray',
    'tumehall': 'dark gray',
    'beeÅ¾': 'beige',
    'sinine': 'blue',
    'lilla': 'purple',
    'pruun': 'brown',
    'tumepunane': 'dark red',
    'oranÅ¾': 'orange',
    'helehall': 'light gray',
    'tumesinine': 'dark blue',
    'tumeroheline': 'dark green',
    'helebeeÅ¾': 'light beige',
    'kollane': 'yellow',
    'kuldne': 'gold',
    'helepruun': 'light brown',
    'tumepruun': 'dark brown',
    'tumeoranÅ¾': 'dark orange',
    'helekollane': 'light yellow',
    'tumelilla': 'dark purple',
    'tumebeeÅ¾': 'dark beige',
    'roosa': 'pink',
    'Gold': 'gold',
    'helepunane': 'light red',
    'Bentayga': 'Bentayga',  # Model name, not a color
    'Rose': 'rose'
}

# Replace values
df['color'] = df['color'].replace(color_translation)

df = df[df['color'] != 'Bentayga']

# Count spaces in brand column
space_count = df['brand'].str.count(' ')

# Create model column
df['model'] = None

# Only split where there's exactly 1 space (2 words)
mask = space_count == 1

# Split and assign for rows with exactly 1 space
df.loc[mask, 'model'] = df.loc[mask, 'brand'].str.split(' ').str[1]
df.loc[mask, 'brand'] = df.loc[mask, 'brand'].str.split(' ').str[0]

# Get the column index of 'brand'
brand_index = df.columns.get_loc('brand')

# Reorder columns - insert model right after brand
cols = df.columns.tolist()
cols.remove('model')
cols.insert(brand_index + 1, 'model')
df = df[cols]

df['brand'].unique()

df = df[df['brand'] != 'Land']
df = df[df['brand'] != 'MCC']

# Create mask for rows containing 'Land Rover'
land_rover_mask = df['brand'].str.contains('Land Rover', na=False)

# For Land Rover rows, extract everything after 'Land Rover'
df.loc[land_rover_mask, 'model'] = df.loc[land_rover_mask, 'brand'].str.replace('Land Rover', '', n=1).str.strip()

# Set brand to 'Land Rover' for those rows
df.loc[land_rover_mask, 'brand'] = 'Land Rover'

land_rover_mask = df['brand'].str.contains('Alfa Romeo', na=False)

df.loc[land_rover_mask, 'model'] = df.loc[land_rover_mask, 'brand'].str.replace('Alfa Romeo', '', n=1).str.strip()

df.loc[land_rover_mask, 'brand'] = 'Alfa Romeo'

land_rover_mask = df['brand'].str.contains('Aston Martin', na=False)

df.loc[land_rover_mask, 'model'] = df.loc[land_rover_mask, 'brand'].str.replace('Aston Martin', '', n=1).str.strip()

df.loc[land_rover_mask, 'brand'] = 'Aston Martin'

# Create mask for rows with at least 2 spaces
mask = df['brand'].str.count(' ') >= 2

# For these rows, split on first space only
# First word goes to brand, everything else to model
df.loc[mask, 'model'] = df.loc[mask, 'brand'].str.split(' ', n=1).str[1]
df.loc[mask, 'brand'] = df.loc[mask, 'brand'].str.split(' ', n=1).str[0]

# Count occurrences of each brand
brand_counts = df['brand'].value_counts()

# Get brands that appear more than once
brands_to_keep = brand_counts[brand_counts > 10].index

# Keep only rows with brands that appear more than once
df = df[df['brand'].isin(brands_to_keep)]

# Create mask for models with more than 2 words (at least 2 spaces)
mask = df['model'].str.count(' ') >= 2

# Keep only first 2 words for those rows
df.loc[mask, 'model'] = df.loc[mask, 'model'].str.split(' ', n=2).str[:2].str.join(' ')

df['model'] = df['model'].apply(
    lambda x: x if pd.isna(x) or 'Land Cruiser' in str(x) else str(x).split()[0]
)

model_counts = df['model'].value_counts()

models_to_keep = model_counts[model_counts > 10].index

df = df[df['model'].isin(models_to_keep)]

df['engine_size'] = df['engine'].str.extract(r'^([\d.]+)')[0]
df['power'] = df['engine'].str.extract(r'(\d+kW)')[0]
df['power'] = df['power'].str.replace('kW', '')
df.drop('engine', axis=1, inplace=True)

df.head()

# df.loc[df['model'].str.startswith('Outlander', na=False), 'model'] = 'Outlander'
# df.loc[df['model'].str.startswith('Pacifica', na=False), 'model'] = 'Pacifica'
# df.loc[df['model'].str.startswith('Passat', na=False), 'model'] = 'Passat'
# df.loc[df['model'].str.startswith('e-tron', na=False), 'model'] = 'e-tron'
# df.loc[df['model'].str.startswith('Z3', na=False), 'model'] = 'Z3'
# df.loc[df['model'].str.startswith('Z4', na=False), 'model'] = 'Z4'
# df.loc[df['model'].str.startswith('ZR-V', na=False), 'model'] = 'ZR-V'
# df.loc[df['model'].str.startswith('Zafira', na=False), 'model'] = 'Zafira'
# df.loc[df['model'].str.startswith('Yaris', na=False), 'model'] = 'Yaris'
# df.loc[df['model'].str.startswith('Zoe', na=False), 'model'] = 'Zoe'
# df.loc[df['model'].str.startswith('Yeti', na=False), 'model'] = 'Yeti'
# df.loc[df['model'].str.startswith('bZ4X', na=False), 'model'] = 'bZ4X'
# df.loc[df['model'].str.startswith('i10', na=False), 'model'] = 'i10'
# df.loc[df['model'].str.startswith('i20', na=False), 'model'] = 'i20'
# df.loc[df['model'].str.startswith('i3', na=False), 'model'] = 'i3'
# df.loc[df['model'].str.startswith('i30', na=False), 'model'] = 'i30'
# df.loc[df['model'].str.startswith('i40', na=False), 'model'] = 'i40'
# df.loc[df['model'].str.startswith('ix35', na=False), 'model'] = 'ix35'
# df.loc[df['model'].str.startswith('iX3', na=False), 'model'] = 'iX3'
# df.loc[df['model'].str.startswith('iX2', na=False), 'model'] = 'iX2'
# df.loc[df['model'].str.startswith('iX', na=False), 'model'] = 'iX'
# df.loc[df['model'].str.startswith('i8', na=False), 'model'] = 'i8'
# df.loc[df['model'].str.startswith('i7', na=False), 'model'] = 'i7'
# df.loc[df['model'].str.startswith('i5', na=False), 'model'] = 'i5'
# df.loc[df['model'].str.startswith('i4', na=False), 'model'] = 'i4'
# df.loc[df['model'].str.startswith('cee\'d', na=False), 'model'] = 'ceed'
# df.loc[df['model'].str.startswith('XC90', na=False), 'model'] = 'XC90'
# df.loc[df['model'].str.startswith('XC70', na=False), 'model'] = 'XC70'
# df.loc[df['model'].str.startswith('XC60', na=False), 'model'] = 'XC60'
# df.loc[df['model'].str.startswith('XC40', na=False), 'model'] = 'XC40'
# df.loc[df['model'].str.startswith('XCeed', na=False), 'model'] = 'XCeed'
# df.loc[df['model'].str.startswith('XV', na=False), 'model'] = 'XV'
# df.loc[df['model'].str.startswith('XJ', na=False), 'model'] = 'XJ'
# df.loc[df['model'].str.startswith('XKR', na=False), 'model'] = 'XKR'
# df.loc[df['model'].str.startswith('XM', na=False), 'model'] = 'XM'
# df.loc[df['model'].str.startswith('Xsara', na=False), 'model'] = 'Xsara'
# df.loc[df['model'].str.startswith('X1', na=False), 'model'] = 'X1'
# df.loc[df['model'].str.startswith('X2', na=False), 'model'] = 'X2'
# df.loc[df['model'].str.startswith('X3', na=False), 'model'] = 'X3'
# df.loc[df['model'].str.startswith('X4', na=False), 'model'] = 'X4'
# df.loc[df['model'].str.startswith('X5', na=False), 'model'] = 'X5'
# df.loc[df['model'].str.startswith('X6', na=False), 'model'] = 'X6'
# df.loc[df['model'].str.startswith('X7', na=False), 'model'] = 'X7'
# df.loc[df['model'].str.startswith('XF', na=False), 'model'] = 'XF'

print(f"Dataset shape at this point: {df.shape}")

import numpy as np
import re

print("\nðŸ“Š --- Basic Info ---")
df.info()
print("\nMissing values per column:")
print(df.isna().sum())

# Drop rows containing null
df = df.dropna(subset=['engine_size', 'power']).reset_index(drop=True)
missing_after = df[['engine_size', 'power']].isna().sum()
print("Shape after dropping:", {df.shape})

# --- 1. Drop unnecessary column (url) ---
df = df.drop(columns=['url'])
print("After dropping url:", df.shape)

# --- 2. Remove unrealistic prices ---
df = df[df['price'] >= 300]   # Drop cars below 300 â‚¬
print("Remaining cars:", len(df))

# --- 3. Identify categorical and numeric columns ---
cat_cols = df.select_dtypes(include=['object']).columns.tolist()
num_cols = df.select_dtypes(include=[np.number]).columns.tolist()
print("\nCategorical columns:", cat_cols)
print("Numeric columns:", num_cols)

print("\nUnique counts per column:")
print(df.nunique())

# Convert engine_size and power to numeric
for col in ['engine_size', 'power']:
    df[col] = (
        df[col]
        .astype(str)                     # ensure string format
        .str.replace(',', '.', regex=False)  # convert commas to dots if present
        .str.extract(r'(\d+\.?\d*)')[0]      # extract numeric part
    )
    df[col] = pd.to_numeric(df[col], errors='coerce')  # convert to float, NaN if invalid

# Check conversion results
print(df[['engine_size', 'power']].dtypes)
print(df[['engine_size', 'power']].head(10))

# --- 3. Identify categorical and numeric columns ---
cat_cols = df.select_dtypes(include=['object']).columns.tolist()
num_cols = df.select_dtypes(include=[np.number]).columns.tolist()
print("\nCategorical columns:", cat_cols)
print("Numeric columns:", num_cols)

import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import MinMaxScaler
from sklearn.linear_model import LinearRegression
import numpy as np
from sklearn.metrics import mean_absolute_error, mean_squared_error

# --- 1. Handle 'model' grouping by average price ---
group_size = 5
model_price = df.groupby('model')['price'].mean().sort_values(ascending=False)
model_groups = {model: i // group_size for i, model in enumerate(model_price.index)}
df['model_group'] = df['model'].map(model_groups)
df = df.drop(columns=['model'])

# --- 2. Handle rare colors (group uncommon colors as 'other') ---
color_counts = df['color'].value_counts()
rare_colors = color_counts[color_counts < 50].index
df['color'] = df['color'].replace(rare_colors, 'other')

# --- 3. Separate target and features ---
y = df['price']
X = df.drop(columns=['price'])

# --- 4. Identify categorical and numeric columns ---
categorical_cols = X.select_dtypes(include='object').columns.tolist()
numeric_cols = X.select_dtypes(include=['float64', 'int64']).columns.tolist()

# --- 5. Scale numeric columns ---
scaler = MinMaxScaler()
X[numeric_cols] = scaler.fit_transform(X[numeric_cols])

# Invert mileage scale (so low mileage = 1, high mileage = 0)
if 'mileage' in X.columns:
    X['mileage'] = 1 - X['mileage']

# --- 6. One-hot encode categorical columns ---
X = pd.get_dummies(X, columns=categorical_cols, drop_first=True)

# --- 7. Split into train and test sets ---
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# --- 8. Train Linear Regression model ---
lr_model = LinearRegression()
lr_model.fit(X_train, y_train)

# --- 9. Predict on test set ---
y_pred = lr_model.predict(X_test)

# --- 10. Evaluate model ---
train_r2 = lr_model.score(X_train, y_train)
test_r2 = lr_model.score(X_test, y_test)

mae = mean_absolute_error(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))
median_price = np.median(y_test)

mae_pct = (mae / median_price) * 100
rmse_pct = (rmse / median_price) * 100

print(f"Training RÂ²: {train_r2:.3f}")
print(f"Test RÂ²: {test_r2:.3f}")
print(f"Median price: {median_price:.2f} euros")
print(f"MAE: {mae:.2f} euros ({mae_pct:.2f}%)")
print(f"RMSE: {rmse:.2f} euros ({rmse_pct:.2f}%)")

lr_model.coef_

df.head()

